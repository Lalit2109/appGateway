# Azure Pipeline for App Gateway Maintenance Mode Management
# This pipeline allows you to switch App Gateway routing rules between
# maintenance mode (static page) and normal mode (backend pool)

trigger: none  # Manual trigger only for safety

pr: none

parameters:
  - name: environment
    displayName: 'Environment'
    type: string
    default: 'dev'
    values:
      - 'dev'
      - 'dev002'
      - 'test'
      - 'test002'
      - 'prod'
      - 'prod002'
  
  - name: action
    displayName: 'Action'
    type: string
    default: 'Maintenance'
    values:
      - Maintenance
      - Normal
  
  - name: redirectURL
    displayName: 'Maintenance Redirect URL'
    type: string
    default: 'https://www.google.com'

pool:
  vmImage: 'windows-latest'

variables:
  - group: 'AppGateway-Config'  # Optional: Store sensitive config in Variable Groups
  - name: workingDirectory
    value: '$(System.DefaultWorkingDirectory)'
  - name: serviceConnectionName
    ${{ if or(eq(parameters.environment, 'dev'), eq(parameters.environment, 'dev002')) }}:
      value: 'YOUR-SPN-NAME-FOR-DEV'  # TODO: Replace with your actual SPN service connection name for dev
    ${{ elseif or(eq(parameters.environment, 'test'), eq(parameters.environment, 'test002')) }}:
      value: 'YOUR-SPN-NAME-FOR-STAGING'  # TODO: Replace with your actual SPN service connection name for staging
    ${{ elseif or(eq(parameters.environment, 'prod'), eq(parameters.environment, 'prod002')) }}:
      value: 'YOUR-SPN-NAME-FOR-PROD'  # TODO: Replace with your actual SPN service connection name for prod
    ${{ else }}:
      value: 'YOUR-SPN-NAME-FOR-DEFAULT'  # TODO: Replace with your default SPN service connection name

stages:
  - stage: Validate
    displayName: 'Validate Parameters'
    jobs:
      - job: ValidateParameters
        displayName: 'Check Required Parameters'
        steps:
          - task: PowerShell@2
            displayName: 'Validate Input Parameters'
            inputs:
              targetType: 'inline'
              script: |
                Write-Host "Validating parameters..."
                Write-Host "Environment: ${{ parameters.environment }}" -ForegroundColor Cyan
                Write-Host "Action: ${{ parameters.action }}"
                if ('${{ parameters.action }}' -eq 'Maintenance') {
                  Write-Host "Maintenance Redirect URL: ${{ parameters.redirectURL }}" -ForegroundColor Cyan
                }
                Write-Host "Service Connection (SPN): $(serviceConnectionName)" -ForegroundColor Cyan
                
                # Validate config file exists
                $configPath = "$(workingDirectory)/config/environments.json"
                if (Test-Path $configPath) {
                  $config = Get-Content $configPath -Raw | ConvertFrom-Json
                  $envConfig = $config.environments.'${{ parameters.environment }}'
                  if ($envConfig) {
                    Write-Host "Configuration loaded for environment: ${{ parameters.environment }}"
                    Write-Host "Resource Group: $($envConfig.resourceGroupName)" -ForegroundColor Yellow
                    Write-Host "App Gateway: $($envConfig.appGatewayName)" -ForegroundColor Yellow
                    if ($envConfig.maintenance) {
                      Write-Host "Maintenance Routing Rules: $($envConfig.maintenance.routingRules -join ', ')" -ForegroundColor Yellow
                    }
                    if ($envConfig.normal) {
                      Write-Host "Normal Mode Routing Rules:" -ForegroundColor Yellow
                      foreach ($rule in $envConfig.normal.routingRules) {
                        Write-Host "  - $($rule.ruleName): Pool=$($rule.backendPoolName), Settings=$($rule.backendSettings)" -ForegroundColor Yellow
                      }
                    }
                  } else {
                    Write-Warning "Environment '${{ parameters.environment }}' not found. Available: $($config.environments.PSObject.Properties.Name -join ', ')"
                  }
                } else {
                  Write-Warning "Config file not found at: $configPath"
                }
                
                Write-Host "Validation complete."

  - stage: Approval
    displayName: 'Approval Required'
    dependsOn: Validate
    jobs:
      - job: WaitForApproval
        displayName: 'Wait for Manual Approval'
        pool: server
        steps:
          - task: ManualValidation@0
            displayName: 'Approve App Gateway Changes'
            timeoutInMinutes: 15
            inputs:
              notifyUsers: ''
              onTimeout: 'reject'
              instructions: |
                ========================================
                APP GATEWAY ROUTING RULE CHANGE REQUEST
                ========================================
                
                OPERATION DETAILS:
                -----------------
                Environment: ${{ parameters.environment }}
                Action: ${{ parameters.action }}
                App Gateway: (See Validation stage for details)
                Service Connection (SPN): $(serviceConnectionName)
                
                CHANGE SUMMARY:
                --------------
                This operation will modify routing rules in the Application Gateway.
                
                What will happen:
                • Routing rules specified in the configuration will be updated
                • Changes will be applied immediately upon approval
                • All affected routing rules will be modified in a single operation
                
                For MAINTENANCE Mode:
                • Routing rules will redirect all traffic to an external URL
                • Backend pools and backend settings will be removed from routing rules
                • Users will be redirected away from backend services
                • Redirect URL: ${{ parameters.redirectURL }}
                
                For NORMAL Mode:
                • Routing rules will be restored to use configured backend pools
                • Backend HTTP settings will be reattached to routing rules
                • Redirect configuration will be removed
                • Normal traffic flow to backend services will resume
                
                Impact:
                ⚠️  This change affects ALL traffic to the specified routing rules
                ⚠️  Changes are immediate and cannot be undone automatically
                ⚠️  Review the Validation stage output for specific routing rule names
                
                Routing Rules Affected:
                (Check the Validation stage output above for the specific routing rule names, backend pools, and settings)
                
                To verify what will change:
                1. Review the Validation stage output above for complete details
                2. Check the routing rules listed in the configuration file
                3. For Maintenance: Confirm the redirect URL is correct
                4. For Normal: Verify backend pool and settings names match your configuration
                
                IMPORTANT NOTES:
                ---------------
                • This approval will timeout after 15 minutes if not approved
                • Once approved, changes will be applied immediately
                • Review the Validation stage output for complete configuration details
                • Ensure you have verified the correct environment
                • Double-check the Action (Maintenance/Normal) is correct for your intent
                
                ========================================

  - stage: ManageAppGateway
    displayName: 'Manage App Gateway Routing'
    dependsOn: Approval
    jobs:
      - job: SetAppGatewayRedirect
        displayName: 'Set App Gateway Redirect'
        steps:
          - checkout: self
            displayName: 'Checkout Repository'
          
          - task: PowerShell@2
            displayName: 'Build Script Arguments'
            inputs:
              targetType: 'inline'
              script: |
                $args = "-Environment '${{ parameters.environment }}' -Action '${{ parameters.action }}'"
                if ('${{ parameters.action }}' -eq 'Maintenance') {
                  $args += " -MaintenanceRedirectURL '${{ parameters.redirectURL }}'"
                }
                Write-Host "##vso[task.setvariable variable=scriptArguments]$args"
                Write-Host "Script Arguments: $args"
          
          - task: AzurePowerShell@5
            displayName: 'Azure Login'
            inputs:
              azureSubscription: '$(serviceConnectionName)'  # Automatically selected based on environment
              ScriptType: 'FilePath'
              ScriptPath: '$(workingDirectory)/Scripts/Invoke-AppGatewayRedirect.ps1'
              ScriptArguments: '$(scriptArguments)'
              azurePowerShellVersion: 'LatestVersion'
              pwsh: true
          

  - stage: Notify
    displayName: 'Send Notifications'
    dependsOn: ManageAppGateway
    condition: always()
    jobs:
      - job: SendNotification
        displayName: 'Notify Team'
        steps:
          - task: PowerShell@2
            displayName: 'Log Operation Result'
            inputs:
              targetType: 'inline'
              script: |
                Write-Host "========================================"
                Write-Host "App Gateway Redirect Operation Summary"
                Write-Host "========================================"
                Write-Host "Environment: ${{ parameters.environment }}"
                Write-Host "Action: ${{ parameters.action }}"
                Write-Host "Status: $(Agent.JobStatus)"
                Write-Host ""
                Write-Host "Note: Check the script output above for details on which routing rules were processed."
                Write-Host "========================================"
                
                # You can add email/Slack/Teams notification here
                # Example: Send email using Send-MailMessage or call webhook

