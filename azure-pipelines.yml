# Azure Pipeline for App Gateway Maintenance Mode Management
# This pipeline allows you to switch App Gateway routing rules between
# maintenance mode (static page) and normal mode (backend pool)

trigger: none  # Manual trigger only for safety

pr: none

parameters:
  - name: environment
    displayName: 'Environment'
    type: string
    default: 'dev'
    values:
      - dev
      - staging
      - prod
  
  - name: action
    displayName: 'Action'
    type: string
    default: 'Maintenance'
    values:
      - Maintenance
      - Normal
  
  - name: subEnvironment
    displayName: 'Sub-Environment'
    type: string
    default: 'dev'
    values:
      - 'dev'
      - 'dev002'
      - 'test'
      - 'test002'
      - 'prod'
      - 'prod002'
  
  - name: redirectURL
    displayName: 'Maintenance Redirect URL'
    type: string
    default: 'https://www.google.com'

pool:
  vmImage: 'windows-latest'

variables:
  - group: 'AppGateway-Config'  # Optional: Store sensitive config in Variable Groups
  - name: workingDirectory
    value: '$(System.DefaultWorkingDirectory)'
  - name: serviceConnectionName
    ${{ if eq(parameters.environment, 'dev') }}:
      value: 'YOUR-SPN-NAME-FOR-DEV'  # TODO: Replace with your actual SPN service connection name for dev
    ${{ elseif eq(parameters.environment, 'staging') }}:
      value: 'YOUR-SPN-NAME-FOR-STAGING'  # TODO: Replace with your actual SPN service connection name for staging
    ${{ elseif eq(parameters.environment, 'prod') }}:
      value: 'YOUR-SPN-NAME-FOR-PROD'  # TODO: Replace with your actual SPN service connection name for prod
    ${{ else }}:
      value: 'YOUR-SPN-NAME-FOR-DEFAULT'  # TODO: Replace with your default SPN service connection name

stages:
  - stage: Validate
    displayName: 'Validate Parameters'
    jobs:
      - job: ValidateParameters
        displayName: 'Check Required Parameters'
        steps:
          - task: PowerShell@2
            displayName: 'Validate Input Parameters'
            inputs:
              targetType: 'inline'
              script: |
                Write-Host "Validating parameters..."
                Write-Host "Environment: ${{ parameters.environment }}"
                Write-Host "Sub-Environment: ${{ parameters.subEnvironment }}" -ForegroundColor Cyan
                Write-Host "Action: ${{ parameters.action }}"
                if ('${{ parameters.action }}' -eq 'Maintenance') {
                  Write-Host "Maintenance Redirect URL: ${{ parameters.redirectURL }}" -ForegroundColor Cyan
                }
                Write-Host "Service Connection (SPN): $(serviceConnectionName)" -ForegroundColor Cyan
                
                # Validate config file exists
                $configPath = "$(workingDirectory)/config/environments.json"
                if (Test-Path $configPath) {
                  $config = Get-Content $configPath -Raw | ConvertFrom-Json
                  $envConfig = $config.environments.'${{ parameters.environment }}'
                  if ($envConfig) {
                    Write-Host "Configuration loaded for environment: ${{ parameters.environment }}"
                    if ($envConfig.subEnvironments) {
                      Write-Host "Sub-Environments structure detected" -ForegroundColor Green
                      $subEnvParam = '${{ parameters.subEnvironment }}'
                      if ($envConfig.subEnvironments.$subEnvParam) {
                        $subEnvConfig = $envConfig.subEnvironments.$subEnvParam
                        Write-Host "Sub-Environment: $subEnvParam" -ForegroundColor Cyan
                        if ($subEnvConfig.maintenance) {
                          Write-Host "Maintenance Routing Rules: $($subEnvConfig.maintenance.routingRules -join ', ')" -ForegroundColor Yellow
                        }
                        if ($subEnvConfig.normal) {
                          Write-Host "Normal Mode Routing Rules:" -ForegroundColor Yellow
                          foreach ($rule in $subEnvConfig.normal.routingRules) {
                            Write-Host "  - $($rule.ruleName): Pool=$($rule.backendPoolName)" -ForegroundColor Yellow
                          }
                        }
                      } else {
                        Write-Warning "Sub-environment '$subEnvParam' not found. Available: $($envConfig.subEnvironments.PSObject.Properties.Name -join ', ')"
                      }
                    } else {
                      # Legacy structure
                      if ($envConfig.maintenance) {
                        Write-Host "Maintenance Redirect URL: $($envConfig.maintenance.redirectURL)" -ForegroundColor Yellow
                        Write-Host "Maintenance Routing Rules: $($envConfig.maintenance.routingRules -join ', ')" -ForegroundColor Yellow
                      }
                      if ($envConfig.normal) {
                        Write-Host "Normal Mode Routing Rules:" -ForegroundColor Yellow
                        foreach ($rule in $envConfig.normal.routingRules) {
                          Write-Host "  - $($rule.ruleName): Pool=$($rule.backendPoolName)" -ForegroundColor Yellow
                        }
                      }
                    }
                  }
                } else {
                  Write-Warning "Config file not found at: $configPath"
                }
                
                Write-Host "Validation complete."

  - stage: Approval
    displayName: 'Approval Required'
    dependsOn: Validate
    jobs:
      - job: WaitForApproval
        displayName: 'Wait for Manual Approval'
        pool: server
        steps:
          - task: ManualValidation@0
            displayName: 'Approve App Gateway Changes'
            timeoutInMinutes: 15
            inputs:
              notifyUsers: ''
              onTimeout: 'reject'
              instructions: |
                Please review the changes before proceeding.
                
                Environment: ${{ parameters.environment }}
                Sub-Environment: ${{ parameters.subEnvironment }}
                Action: ${{ parameters.action }}
                Service Connection (SPN): $(serviceConnectionName)
                
                This will modify the App Gateway routing rules specified in the configuration file.
                Check the Validation stage output for the specific routing rules that will be affected.
                
                This approval will timeout after 15 minutes if not approved.
              onReject: 'reject'

  - stage: ManageAppGateway
    displayName: 'Manage App Gateway Routing'
    dependsOn: Approval
    jobs:
      - job: SetAppGatewayRedirect
        displayName: 'Set App Gateway Redirect'
        steps:
          - checkout: self
            displayName: 'Checkout Repository'
          
          - task: AzurePowerShell@5
            displayName: 'Azure Login'
            inputs:
              azureSubscription: '$(serviceConnectionName)'  # Automatically selected based on environment
              ScriptType: 'FilePath'
              ScriptPath: '$(workingDirectory)/Scripts/Invoke-AppGatewayRedirect.ps1'
              ScriptArguments: >
                -Environment '${{ parameters.environment }}'
                -Action '${{ parameters.action }}'
                -SubEnvironment '${{ parameters.subEnvironment }}'
                ${{ if eq(parameters.action, 'Maintenance') }}:
                -MaintenanceRedirectURL '${{ parameters.redirectURL }}'
                ${{ endif }}
              azurePowerShellVersion: 'LatestVersion'
              pwsh: true
          

  - stage: Notify
    displayName: 'Send Notifications'
    dependsOn: ManageAppGateway
    condition: always()
    jobs:
      - job: SendNotification
        displayName: 'Notify Team'
        steps:
          - task: PowerShell@2
            displayName: 'Log Operation Result'
            inputs:
              targetType: 'inline'
              script: |
                Write-Host "========================================"
                Write-Host "App Gateway Redirect Operation Summary"
                Write-Host "========================================"
                Write-Host "Environment: ${{ parameters.environment }}"
                Write-Host "Action: ${{ parameters.action }}"
                Write-Host "Status: $(Agent.JobStatus)"
                Write-Host ""
                Write-Host "Note: Check the script output above for details on which routing rules were processed."
                Write-Host "========================================"
                
                # You can add email/Slack/Teams notification here
                # Example: Send email using Send-MailMessage or call webhook

