# Simplified Azure Pipeline - Direct PowerShell execution
# Alternative to the main pipeline if you prefer simpler approach

trigger: none

pr: none

parameters:
  - name: environment
    displayName: 'Environment'
    type: string
    default: 'dev'
    values:
      - dev
      - staging
      - prod
  
  - name: action
    displayName: 'Action'
    type: string
    default: 'Maintenance'
    values:
      - Maintenance
      - Normal

pool:
  vmImage: 'windows-latest'

variables:
  - name: workingDirectory
    value: '$(System.DefaultWorkingDirectory)'
  - name: serviceConnectionName
    ${{ if eq(parameters.environment, 'dev') }}:
      value: 'YOUR-SPN-NAME-FOR-DEV'  # TODO: Replace with your actual SPN service connection name for dev
    ${{ elseif eq(parameters.environment, 'staging') }}:
      value: 'YOUR-SPN-NAME-FOR-STAGING'  # TODO: Replace with your actual SPN service connection name for staging
    ${{ elseif eq(parameters.environment, 'prod') }}:
      value: 'YOUR-SPN-NAME-FOR-PROD'  # TODO: Replace with your actual SPN service connection name for prod
    ${{ else }}:
      value: 'YOUR-SPN-NAME-FOR-DEFAULT'  # TODO: Replace with your default SPN service connection name

stages:
  - stage: Approval
    displayName: 'Approval Required'
    jobs:
      - job: WaitForApproval
        displayName: 'Wait for Manual Approval'
        pool: server
        steps:
          - task: ManualValidation@0
            displayName: 'Approve App Gateway Changes'
            timeoutInMinutes: 15
            inputs:
              notifyUsers: ''
              onTimeout: 'reject'
              instructions: |
                Please review the changes before proceeding.
                
                Environment: ${{ parameters.environment }}
                Action: ${{ parameters.action }}
                
                This will modify the App Gateway routing rules specified in the configuration file.
                
                This approval will timeout after 15 minutes if not approved.
              onReject: 'reject'

  - stage: ManageAppGateway
    displayName: 'Manage App Gateway'
    dependsOn: Approval
    jobs:
      - job: SetRedirect
        displayName: 'Set App Gateway Redirect'
        steps:
          - checkout: self
          
          - task: AzurePowerShell@5
            displayName: 'Execute Redirect Script'
            inputs:
              azureSubscription: '$(serviceConnectionName)'  # Automatically selected based on environment
              ScriptType: 'FilePath'
              ScriptPath: '$(workingDirectory)/Scripts/Invoke-AppGatewayRedirect.ps1'
              ScriptArguments: >
                -Environment '${{ parameters.environment }}'
                -Action '${{ parameters.action }}'
              azurePowerShellVersion: 'LatestVersion'
              pwsh: true

